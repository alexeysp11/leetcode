# ef 

## Общая информация

EntityFramework - это ORM (Object-Relational Mapping) фреймворк для .NET, который позволяет работать с данными в базе данных в виде объектов. 
Он предоставляет множество преимуществ, таких как упрощение работы с базой данных, повышение производительности, уменьшение количества кода, улучшение безопасности при работе с данными и другие.

### Типы отношений между таблицами

EntityFramework поддерживает следующие типы отношений между таблицами: один к одному, один ко многим, многие ко многим.

В EntityFramework тип отношений "один к одному" между таблицами реализуется с помощью свойства навигации типа `virtual` в классе модели, которое ссылается на другой класс модели. Это свойство может быть установлено как обязательное (`required`) или необязательное (`optional`).

Тип отношений "один ко многим" между таблицами реализуется в EntityFramework с помощью свойства навигации типа `ICollection<T>` или `IList<T>` в классе модели, которое ссылается на коллекцию других классов модели.

Тип отношений "многие ко многим" между таблицами реализуется в EntityFramework с помощью создания промежуточной таблицы, которая содержит ключи обеих таблиц. Затем свойства навигации типа `ICollection<T>` или `IList<T>` устанавливаются для обеих таблиц, чтобы указать на промежуточную таблицу.

### Подходы к созданию БД

В EntityFramework существуют следующие подходы к созданию БД: Code First и Database first.

#### Code First

Code First подход в EntityFramework позволяет создавать базу данных на основе классов сущностей (Entity), а не на основе уже существующей базы данных. 

Он работает следующим образом: сначала создается класс сущности, затем создается контекст базы данных, который настраивается на основе класса сущности. После этого можно использовать контекст для создания и изменения базы данных.

#### Database first

Подход Database first в EntityFramework заключается в создании модели данных на основе существующей БД. 
Сначала создается файл модели (.edmx), который содержит метаданные БД, затем генерируется код на основе этих метаданных.

Файл edmx — это XML-файл, который определяет модель данных объекта (EDM), описывает схему целевой базы данных и определяет сопоставление между EDM и базой данных. 
Файл edmx также содержит информацию, которая используется конструктором модели Entity Data Model ADO.NET (Entity Designer) для графической визуализации модели.

### Методы для выполнения запросов к базе данных

Для выполнения запросов к базе данных в EntityFramework используются следующие методы: LINQ to Entities (Language-Integrated Query), методы расширения `Queryable` и `DbSet`, SQL-запросы через методы `Database.SqlQuery` и `ExecuteSqlCommand`.

### Транзакции

Для управления транзакциями в EntityFramework используются методы контекста базы данных, такие как `SaveChanges`, `SaveChangesAsync`, `BeginTransaction`, `Commit`, `Rollback` и другие.

Метод `SaveChanges()` в EntityFramework выполняет сохранение всех изменений, внесенных в объекты контекста базы данных, в соответствующую базу данных. 
Это может включать добавление, изменение или удаление записей в таблицах базы данных.

### Хранимые процедуры

Для работы с хранимыми процедурами в EntityFramework используются методы контекста базы данных, такие как `Database.SqlQuery` и `ExecuteSqlCommand`. Они позволяют вызывать хранимые процедуры и обрабатывать результаты их выполнения.

### Фильтрация

EntityFramework поддерживает различные типы фильтрации данных, включая фильтрацию по условию (`Where`), сортировку (`OrderBy`, `ThenBy`), группировку (`GroupBy`), ограничение количества записей (`Take`, `Skip`), агрегатные функции (`Sum`, `Count`, `Average`, `Min`, `Max`) и другие.

#### Работа с несколькими контекстами данных

Для работы с несколькими контекстами данных в EntityFramework можно использовать следующие методы:
- `DbContext.Database.UseTransaction(transaction)` - устанавливает транзакцию для контекста базы данных
- `DbContext.Database.BeginTransaction()` - начинает новую транзакцию для контекста базы данных
- `DbContext.Database.CommitTransaction()` - коммитит текущую транзакцию для контекста базы данных
- `DbContext.Database.RollbackTransaction()` - откатывает текущую транзакцию для контекста базы данных

### Типы наследования

EntityFramework поддерживает следующие типы наследования: 
- Table per Hierarchy (TPH) - все наследованные типы хранятся в одной таблице, с помощью дополнительного поля определяется тип объекта; 
- Table per Type (TPT) - каждый тип наследника хранится в своей таблице, каждая таблица имеет свою уникальную запись и связь с родительской таблицей; 
- Table per Concrete Type (TPC) - каждый класс наследник хранится в отдельной таблице без связей с другими таблицами наследников.

### Типы миграций

EntityFramework поддерживает следующие типы миграций: автоматические миграции и явные миграции. 

#### Автоматические миграции

Автоматические миграции позволяют EntityFramework автоматически обновлять базу данных при изменении модели данных. При запуске приложения EntityFramework проверяет соответствие модели данных и текущей структуры БД и создает миграцию, если она необходима. Затем выполняется скрипт миграции, который обновляет структуру БД.

Для того, чтобы применить автоматическую миграцию в EntityFramework, необходимо включить ее в настройках контекста базы данных.

#### Явные миграции

Явные миграции позволяют создавать и применять миграции вручную. При создании явной миграции EntityFramework анализирует изменения в модели данных и создает скрипт миграции, который можно применить к БД.

Для того, чтобы применить явную миграцию в EntityFramework, необходимо выполнить команду Update-Database в консоли диспетчера пакетов.

### Кэширование 

EntityFramework поддерживает следующие типы кэширования данных: кэширование первого уровня (Local Cache), кэширование второго уровня (Query Cache) и кэширование третьего уровня (Result Cache).

#### Local Cache

Кэширование первого уровня (Local Cache) - это кэш, который хранит объекты в памяти приложения на время жизни контекста базы данных.

Кэширование первого уровня (Local Cache) в EntityFramework реализуется путем хранения объектов, полученных из базы данных, в памяти приложения. Это позволяет уменьшить количество запросов к базе данных и ускорить работу приложения.

Для выполнения кэширования первого уровня (Local Cache) в EntityFramework необходимо использовать методы контекста базы данных, такие как `Find()`, `Add()`, `Remove()` и т.д., которые позволяют получать, добавлять или удалять объекты из кэша.

#### Query Cache

Кэширование второго уровня (Query Cache) - это кэш, который хранит результаты запросов в памяти приложения на время жизни контекста базы данных.

Кэширование второго уровня (Query Cache) в EntityFramework реализуется путем хранения результатов выполнения запросов к базе данных в памяти приложения. Это позволяет уменьшить количество запросов к базе данных и ускорить работу приложения.

Для выполнения кэширования второго уровня (Query Cache) в EntityFramework необходимо использовать методы контекста базы данных, такие как `AsNoTracking()`, которые позволяют получать результаты запросов без отслеживания изменений.

#### Result Cache

Кэширование третьего уровня (Result Cache) - это кэш, который хранит результаты запросов в БД на время жизни контекста базы данных.

Кэширование третьего уровня (Result Cache) в EntityFramework реализуется путем хранения результатов выполнения запросов к базе данных в кэше базы данных. Это позволяет уменьшить количество запросов к базе данных и ускорить работу приложения.

Для выполнения кэширования третьего уровня (Result Cache) в EntityFramework необходимо использовать специальные инструменты, такие как Entity Framework Caching Provider, которые позволяют настроить кэш базы данных и использовать его для хранения результатов запросов.

### Профилирование и отладка запросов

Для профилирования и отладки запросов в EntityFramework можно использовать различные инструменты, такие как SQL Server Profiler, LINQPad, Entity Framework Profiler, MiniProfiler и другие.

Для профилирования и отладки запросов в EntityFramework для PostgreSQL можно использовать такие инструменты, как MiniProfiler или dotTrace.

### Агрегатные функции

EntityFramework поддерживает различные агрегатные функции, такие как `Sum`, `Count`, `Average`, `Min`, `Max` и другие.

Агрегатные функции в EntityFramework используются для выполнения агрегатных операций над данными в таблицах базы данных, таких как сумма, среднее значение, максимальное или минимальное значение и т.д.

### Индексы

EntityFramework поддерживает различные типы индексов, включая кластерные и некластерные индексы, уникальные индексы, полнотекстовые индексы и другие.

### Совместимые технологии для работы с базами данных

Вместе с EntityFramework можно использовать различные технологии для работы с базами данных, такие как ADO.NET, LINQ, Entity SQL, SQL Server Integration Services (SSIS) и другие.

ADO.NET - это технология доступа к данным, которая позволяет работать с БД только с помощью SQL запросов. 

EntityFramework - это ORM (Object-Relational Mapping), которая предоставляет высокоуровневый интерфейс для работы с БД и скрывает детали работы с SQL.
